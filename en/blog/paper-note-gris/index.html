<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- JS for KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    <title>Chris Zhang&#x27;s Blog | Paper Note: Generalized Resampled Importance Sampling - GRIS theory</title>
    
    <link rel="stylesheet" href="https://blog.zcy.moe/style.css?h=05ce8a9f27c3f6647cbb">
    
</head>
<body>
    
<header class="space">
    
        <a href="https:&#x2F;&#x2F;blog.zcy.moe/en">&LeftArrow; Home</a>
    
</header>

    
<main>
    <h1>Paper Note: Generalized Resampled Importance Sampling - GRIS theory</h1>

    
    <div class="post-meta">











<span title="2024-10-15 21:41:09 +0000">October 15, 2024</span>&nbsp;·&nbsp;茨月
</div>
    

    <div class="space"></div>
    <p><a href="https://research.nvidia.com/publication/2022-07_generalized-resampled-importance-sampling-foundations-restir">This article</a> is primarily divided into two parts: the first part supplements the sampling theory of ReSTIR, positioning itself as an extension of the RIS theory in <a href="https://dl.acm.org/doi/10.5555/2383654.2383674">Importance Resampling for Global Illumination</a>, and proposes the so-called GRIS or Generalized RIS theory. The second part applies this theory to path reuse and introduces ReSTIR PT.</p>
<p>This note focuses on the discussion of GRIS theory.</p>
<span id="continue-reading"></span><h2 id="fundamentals-of-ris-theory">Fundamentals of RIS Theory</h2>
<h3 id="background">Background</h3>
<p>Rendering is essentially integration. To integrate a function \(f\) (i.e., compute \(I = \int_\Omega f(x) \text{d}x\)), we need to use a Monte Carlo (MC) integrator, where we first sample points and then compute:</p>
<p>$$
\langle I\rangle = \sum_{i=1}^M \frac{f(X_i)}{p(X_i)}
$$</p>
<p>As long as the support of the distribution \(p\) covers the support of the function \(f\), we have:</p>
<p>$$
E[\langle I \rangle] = \int_\Omega f(x)\text {d}x
$$</p>
<p>This ensures an unbiased estimate. However, the greater the difference between \(p\) and \(f\), the higher the variance of the MC integration. This variance manifests as noise in the rendered result. Therefore, we want the distribution \(p\) to approximate \(f\) as closely as possible.</p>
<h3 id="problem-identical-distributions-for-all-samples">Problem - Identical Distributions for All Samples</h3>
<p>Given a set of samples \(X_1, X_2, ..., X_M\), where all samples are independent and identically distributed according to \(p\), we want to resample \(Y\) from these samples based on certain weights \(w_i\), such that the probability density of \(Y\) approximates the target function \(\hat p = f\).</p>
<p>We define the weights as:</p>
<p>$$
w_i = \frac{1}{M} \hat p(X_i) W_i
$$</p>
<p>where:</p>
<p>$$
W_i = \frac{1}{p(X_i)}
$$</p>
<p>Sampling \(Y\) from \(X_1, X_2, ..., X_M\) according to the weights \(w_i\), we define the unbiased contribution weight as:</p>
<p>$$
W_Y = \frac{1}{\hat p(Y)} \sum_{i=1}^M w_i
$$</p>
<p>As long as the support of the random variable \(Y\) covers the support of the function \(f\), we have \(E[f(Y)W_Y] = I\).</p>
<p><div class="collapsible">
  <details>
    <summary>Proof of Correctness</summary>
    <div class="inner">$$
   \begin{aligned}
   E[f(Y)W_Y] &amp;= E\left[f(Y) \cdot \frac{1}{\hat p(Y)} \cdot \sum_{i=1}^M w_i\right] \\
   &amp;= E\left[ \sum_{i=1}^M w_i \cdot \frac{f(X_i)}{\hat p(X_i)} \right] \\
   &amp;= \frac{1}{M} E\left[ \sum_{i=1}^M\frac{f(X_i)}{p(X_i)} \right] \\
   &amp;= \frac{1}{M} \sum_{i=1}^M E\left[ \frac{f(X_i)}{p(X_i)} \right] \\
   &amp;= \int_\Omega f(x) dx
   \end{aligned}
   $$</div>
  </details>
</div>
Thus, the sampling remains unbiased.</p>
<h3 id="problem-generalization-different-distributions-for-each-sample">Problem - Generalization, Different Distributions for Each Sample</h3>
<p>Given a set of samples \(X_1, X_2, ..., X_M\), where \(X_i\) is distributed according to \(p_i\), we want to resample based on certain weights \(w_i\) such that the resampled probability density approximates the target function \(\hat p\).</p>
<p>To balance across different distributions, we introduce the MIS (Multiple Importance Sampling) weight:</p>
<p>$$
m_i(x) = \frac{p_i(x)}{\sum_{j=1}^M p_j(x)}
$$</p>
<p>It naturally satisfies \(\sum_{i=1}^M m_i(x) = 1\). With MIS, the weights are defined as:</p>
<p>$$
w_i = m_i(X_i) \hat p(X_i) W_i
$$</p>
<p>where:</p>
<p>$$
W_i = \frac{1}{p_i(X_i)}
$$</p>
<ul>
<li>
<p>Degenerate Case:</p>
<p>When all \(p_i = p\), \(m_i = \frac{1}{M}\), and the MIS case degenerates to the naive case described earlier.</p>
</li>
</ul>
<p>The unbiased contribution weight remains unchanged, and we still have \(E[f(Y)W_Y] = I\).</p>
<p><div class="collapsible">
  <details>
    <summary>Proof of Correctness</summary>
    <div class="inner">$$
    \begin{aligned}
    E[f(Y)W_Y] &amp;= E\left[f(Y) \cdot \frac{1}{\hat p(Y)} \cdot \sum_{i=1}^M w_i\right] \\
    &amp;= E\left[ \sum_{i=1}^M w_i \cdot \frac{f(X_i)}{\hat p(X_i)} \right] \\
    &amp;= E\left[ \sum_{i=1}^M m_i(X_i)\frac{f(X_i)}{p_i(X_i)} \right] \\
    &amp;=  \sum_{i=1}^ME\left[  m_i(X_i)\frac{f(X_i)}{p_i(X_i)} \right]\\
    &amp;= \sum_{i=1}^M \int_\Omega m_i(x)\frac{f(x)}{p_i(x)} \cdot p_i(x) \text{d} x \\
    &amp;= \sum_{i=1}^M\int_\Omega   m_i(x) f(x) \text{d} x \\
    &amp;= \int_\Omega  \sum_{i=1}^M m_i(x) f(x) \text{d} x \\
    &amp;= \int_\Omega f(x) \text{d}x
    \end{aligned}
    $$</div>
  </details>
</div>
Notes:</p>
<ul>
<li>
<p>The interchange of summation and expectation is due to the independence of the samples.</p>
</li>
<li>
<p>The integration domains for different samples are not identical. To ensure correctness, the support must cover the target function:</p>
<p>That is, the union of the supports of all \(p_i\) must cover the support of \(f\), i.e., \(\forall x \in \text{supp}(f), \exists, p_i ; \text{s.t. } x\in \text{supp}(p_i)\).</p>
</li>
</ul>
<h2 id="generalized-ris">Generalized RIS</h2>
<p>Building on multi-distribution RIS, this paper introduces Generalized RIS to address reuse across different domains.</p>
<h3 id="background-1">Background</h3>
<p>In simple cases (e.g., ReSTIR DI), the sampling target is the light source distribution, and the target domain for different pixels is identical. However, in more complex reuse scenarios, such as path reuse with ReSTIR, the sampling target is the path space for each pixel, which clearly differs between neighboring pixels. In such cases, we need a way to map samples from other spaces to our target space, known as <em><strong>shift mapping</strong></em>.</p>
<h3 id="formal-definition">Formal Definition</h3>
<p>Assume \(f\) is defined on \(\Omega\). To reuse a sample \(X_s \in \Omega_s\), we need to define a shift mapping \(T: \Omega_s \to \Omega\).</p>
<ul>
<li>
<p>The mapping must satisfy the following:</p>
<ul>
<li>
<p>(If an element \(x\) has a map) It must be deterministic, one-to-one, and reversible.</p>
</li>
<li>
<p>(If an element \(x\) does not have a map) No other element can map to \(x\).</p>
</li>
</ul>
<p>Essentially, this is a bijection from a subset of \(\Omega_s\) to a subset of \(\Omega\), but it can have "holes."</p>
</li>
</ul>
<p>With \(T\), the weights are further defined as:</p>
<p>$$
w_i = m_i(T_i(X_i)) \hat p(T_i(X_i)) W_i \cdot |\partial T_i/\partial X_i|
$$</p>
<p><strong>Note the Jacobian determinant of \(T_i\) here!</strong></p>
<p>We sample from the mapped samples \(Y_1, Y_2, ..., Y_M\), where \(Y_i = T_i(X_i)\), and the weights are \(w_i\).</p>
<p>The definition of \(W_i\) remains unchanged:</p>
<p>$$
W_i = \frac{1}{p_i(X_i)}
$$</p>
<p>The unbiased contribution weight remains unchanged, and we still have \(E[f(Y)W_Y] = I\).</p>
<ul>
<li>
<p>Degenerate Case:</p>
<p>If \(\Omega_i = \Omega\) and \(T = id\), then Generalized RIS degenerates to RIS.</p>
</li>
</ul>
<p><div class="collapsible">
  <details>
    <summary>Proof of Correctness</summary>
    <div class="inner">$$
   \begin{aligned}
   E[f(Y)W_Y] &amp;= E\left[f(Y) \cdot \frac{1}{\hat p(Y)} \cdot \sum_{i=1}^M w_i\right] \\
   &amp;= E\left[ \sum_{i=1}^M w_i \cdot \frac{f(X_i)}{\hat p(X_i)} \right] \\
   &amp;= E\left[ \sum_{i=1}^M m_i(T_i(X_i)) f(T_i(X_i)) \left|\frac{\partial T_i}{\partial x}\right|\right] \\
   &amp;= \sum_{i=1}^ME\left[ m_i(T_i(X_i)) f(T_i(X_i)) \left|\frac{\partial T_i}{\partial x}\right|\right] \\
   &amp;= \sum_{i=1}^M \int_{\Omega_i} m_i(T_i(x)) f(T_i(x)) \left|\frac{\partial T_i}{\partial x}\right| \text{d} x \\
   &amp;= \sum_{i=1}^M \int_{\Omega} m_i(y) f(y) \text{d} y \\
   &amp;= \int_{\Omega} \sum_{i=1}^M m_i(y) f(y) \text{d} y \\
   &amp;= \int_{\Omega} f(y) \text{d} y
   \end{aligned}
   $$</div>
  </details>
</div>
Key points:</p>
<ul>
<li>
<p>The interchange of summation and expectation is due to the independence of the samples.</p>
</li>
<li>
<p>The substitution step applies the change-of-variables formula, where \(y = T_i(x)\), and the Jacobian perfectly accounts for \(\text{d} y\).</p>
</li>
<li>
<p>The final step requires that the union of the images of \(T_i\) covers \(\Omega\).</p>
<ul>
<li>In practical applications, each pixel has its own sample, so there is always at least one \(\Omega_i = \Omega, T_i = id\). Thus, this condition is theoretically guaranteed.</li>
</ul>
</li>
</ul>
<h3 id="necessity-of-mis-with-shift-mapping">Necessity of MIS with Shift Mapping</h3>
<div class="side-by-side-container">
<img alt="Why MIS is needed" id="should-invert" style="width: 85%" src="/images/paper-note-gris/image.webp"/>
</div>
<p>A sample in \(\Omega\) may come from multiple \(\Omega_i\), so MIS is necessary for balancing. Otherwise, the estimator \(\frac{f(Y)}{p_Y(Y)}\) in our MC integrator will have an inaccurate \(p_Y\), leading to bias.</p>
<h2 id="restir-as-chained-gris">ReSTIR - As Chained GRIS</h2>
<p>Using the extended GRIS, ReSTIR can be described as a GRIS chain:</p>
<p>Let \(Y_i^{t-1}\) be a path for pixel \(i\) at frame \(t-1\) (either sampled or resampled). The reservoir stores its unbiased contribution weight \(W_{Y_i^{t-1}}\). At frame \(t\), we proceed as follows:</p>
<ol>
<li>
<p><strong>(Initial Sampling):</strong> For each pixel \(i\), sample an independent sample \(X_i^t\) for the current frame and compute its contribution weight \(W_{X_i^t}\).</p>
</li>
<li>
<p><strong>(Temporal Reuse):</strong> Use GRIS to resample between \(Y_i^{t-1}\) and \(X_i^t\) to obtain \(Z_i\) — potentially applying motion vector warping to the old pixel.</p>
</li>
<li>
<p><strong>(Spatial Reuse):</strong> For each pixel, select some neighbors \(j\) and perform GRIS resampling between \(Z_i\) and the neighbors' \(Z_j\) to obtain \(Y_i^t\).</p>
</li>
<li>
<p><strong>(Output):</strong> Compute \(f_i(Y_i^t) W_{Y_i^t}\) as the estimate of the integral.</p>
</li>
</ol>

</main>

    <div class="dark-mode-buttons">
        <button class="dark-mode-button" id="dark-mode-on"><img src="https://blog.zcy.moe/dark_mode.svg" width="24" height="24" alt=""></button>
        <button class="dark-mode-button" id="dark-mode-off"><img src="https://blog.zcy.moe/light_mode.svg" width="24" height="24" alt=""></button>
    </div>
    <div class="language-switch-buttons">
        <button class="language-switch-button" id="language-switch-dark-on"><img src="https://blog.zcy.moe/translation_dark.svg" width="24" height="24" alt=""></button>
        <button class="language-switch-button" id="language-switch-dark-off"><img src="https://blog.zcy.moe/translation_light.svg" width="24" height="24" alt=""></button>
        <ul class="language-dropdown">
            <li class="language-option" id="switch-to-en">English</li>
            <li class="language-option" id="switch-to-zh-cn">中文</li>
        </ul>
    </div>
    <div id="action-botton">
        <div class="action-wrapper">
            <div class="action meter">
                <span id="progress_meter">JS</span>
            </div>
            <a href="#top" class="action up no-dot">
                <svg xmlns='http://www.w3.org/2000/svg' class='icon' viewBox='0 0 512 512'><title>Arrow Up</title><path fill='none' stroke='currentColor' stroke-linecap='square' stroke-miterlimit='10' stroke-width='48' d='M112 244l144-144 144 144M256 120v292'/></svg>
            </a>
        </div>
    </div>
    <!-- JS for light/dark switch, minified -->
    <script>const cls=document.body.classList;const getSessionTheme=sessionStorage.getItem("theme");if(getSessionTheme==="dark"){cls.toggle("dark-mode",true)}else if(getSessionTheme==="light"){cls.toggle("dark-mode",false)}else if(window.matchMedia("(prefers-color-scheme: dark)").matches){cls.toggle("dark-mode",true)}document.getElementById("dark-mode-on").addEventListener("click",function(e){cls.toggle("dark-mode",true);sessionStorage.setItem("theme","dark")});document.getElementById("dark-mode-off").addEventListener("click",function(e){cls.toggle("dark-mode",false);sessionStorage.setItem("theme","light")});</script>
    <!-- JS for progress meter, minified -->
    <script type="text/javascript">let progress_meter=document.getElementById("progress_meter"),height=document.body.scrollHeight-screen.height,last_position=window.scrollY;function update_progress_meter(){height=document.body.clientHeight-window.innerHeight,current_position=window.scrollY,progress=Math.ceil(current_position/height*100),height==0?progress=100:progress<0?progress=0:progress>100&&(progress=100),progress_meter.innerText=(progress==100?"End":(progress+"%"))}let ticking=!1;window.addEventListener('scroll',function(a){ticking||(window.requestAnimationFrame(function(){update_progress_meter(),ticking=!1}),ticking=!0)}),progress_meter.style.textDecoration='none',update_progress_meter()</script>
    <!-- JS for language toggle, minified -->
    <script type="text/javascript">let toggle_language=function(lang_code){return function(){const currentUrl=window.location.href;const url=new URL(currentUrl);const path=url.pathname;if(!path.startsWith(`/${ lang_code }`)){const newPath=`/${ lang_code }${ path }`;const newUrl=`${url.origin }${ newPath }${url.search }${url.hash }`;window.location.href=newUrl}}};let toggle_default_language=function(){const currentUrl=window.location.href;const url=new URL(currentUrl);const path=url.pathname;const possible_lang_codes=['en'];const lang_code=path.split("/")[1];if(possible_lang_codes.includes(lang_code)){const newPath=path.replace(`/${ lang_code }`,'');const newUrl=`${url.origin }${ newPath }${url.search }${url.hash }`;window.location.href=newUrl}};document.getElementById('switch-to-en').addEventListener('click',toggle_language('en'));document.getElementById('switch-to-zh-cn').addEventListener('click',toggle_default_language);</script>
    <noscript>
        <style>
            .dark-mode-buttons {
                display: none;
            }
        </style>
    </noscript>
</body>
</html>
